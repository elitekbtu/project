import{j as e}from"./ui-DmaJfU4R.js";import{r as a,L as O}from"./router-YsGj19cs.js";import{b as Z,r as D,s as H}from"./chatStylist-BhXqis4H.js";import{I as J}from"./input-DSjIL0vM.js";import{B as i}from"./button-CEL2MslA.js";import{A as k,b as M}from"./avatar-CBOADE_9.js";import{B as u}from"./badge-CMy5sMNA.js";import{A as K,a as P}from"./index-8jId_CL5.js";import{c as f}from"./createLucideIcon-BcwDLXBm.js";import{B as X}from"./bar-chart-3-BxCnkcx5.js";import{R as Y}from"./refresh-cw-uUutlnOJ.js";import{X as G}from"./x-DBAcYj4I.js";import{S as Q}from"./shopping-bag-Din1qLo_.js";import{S as W}from"./shopping-cart-BlvFNc12.js";import{C as ee}from"./chevron-down-B6Nw56k2.js";import{T as te}from"./target-DJx1E-vw.js";import{Z as se}from"./zap-DKaY4BKN.js";import{C as re}from"./clock-B5XmQ9i6.js";import{U as ae}from"./user-BuBPZYTe.js";import"./vendor-BtP0CW_r.js";import"./utils-CytzSlOG.js";import"./index-BwobEAja.js";/**
 * @license lucide-react v0.379.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const A=f("Bot",[["path",{d:"M12 8V4H8",key:"hb8ula"}],["rect",{width:"16",height:"12",x:"4",y:"8",rx:"2",key:"enze0r"}],["path",{d:"M2 14h2",key:"vft8re"}],["path",{d:"M20 14h2",key:"4cs60a"}],["path",{d:"M15 13v2",key:"1xurst"}],["path",{d:"M9 13v2",key:"rq6x2g"}]]);/**
 * @license lucide-react v0.379.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=f("ChevronUp",[["path",{d:"m18 15-6-6-6 6",key:"153udz"}]]);/**
 * @license lucide-react v0.379.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oe=f("ExternalLink",[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]]);/**
 * @license lucide-react v0.379.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _=f("MessageCircle",[["path",{d:"M7.9 20A9 9 0 1 0 4 16.1L2 22Z",key:"vv11sd"}]]),ie=e.jsx(M,{className:"bg-muted text-muted-foreground",children:e.jsx(A,{className:"w-5 h-5"})}),le=e.jsx(M,{className:"bg-muted text-muted-foreground",children:e.jsx(ae,{className:"w-5 h-5"})}),Ie=()=>{const h="chat_stylist_history",[l,c]=a.useState(()=>{try{const t=sessionStorage.getItem(h);return t?JSON.parse(t):[]}catch{return[]}}),[d,v]=a.useState(""),[p,w]=a.useState(!1),[g,y]=a.useState(!1),[j,E]=a.useState(!1),[o,I]=a.useState(null),[z,b]=a.useState(!1),[S,B]=a.useState(new Set),N=a.useRef(null),m=a.useContext(K),n=m&&typeof m=="object"&&m!==null&&"user"in m?m.user:void 0,{addItem:L}=P();a.useEffect(()=>{sessionStorage.setItem(h,JSON.stringify(l))},[l]),a.useEffect(()=>{g&&N.current&&N.current.scrollIntoView({behavior:"smooth"})},[l,g]);const C=async()=>{if(d.trim()){c([...l,{role:"user",text:d}]),w(!0);try{const t=await H(d,n);t.items&&t.items.length>0&&console.log(`Найдено ${t.items.length} товаров в чат-стилисте`);let r=t.reply,s="";const x=r.match(/Совет по размеру:([^\n]+)/i);x&&(s=x[1].trim(),r=r.replace(x[0],"").trim());const V={role:"ai",text:r+(s?`

👕 Совет по размеру: ${s}`:""),items:t.items,intent_type:t.intent_type,confidence:t.confidence,processing_time:t.processing_time};c(F=>[...F,V])}catch(t){console.error("Ошибка отправки сообщения:",t),c(r=>[...r,{role:"ai",text:"Извините, произошла ошибка при обработке вашего запроса. Попробуйте еще раз."}])}finally{v(""),w(!1)}}},R=async()=>{try{n!=null&&n.id&&await D(n.id),c([]),sessionStorage.removeItem(h)}catch(t){console.error("Ошибка сброса диалога:",t),c([]),sessionStorage.removeItem(h)}},$=async()=>{if(n!=null&&n.id){b(!0);try{const t=await Z(n.id);I(t)}catch(t){console.error("Ошибка загрузки статистики:",t)}finally{b(!1)}}},T=async t=>{try{await L({id:t.id,item_id:t.id,name:t.name||"Товар",price:t.price||0,image_url:t.image_url,quantity:1})}catch(r){console.error("Ошибка добавления в корзину:",r)}},q=t=>{B(r=>{const s=new Set(r);return s.has(t)?s.delete(t):s.add(t),s})},U=t=>t.role!=="ai"||!t.intent_type?null:e.jsxs("div",{className:"flex items-center gap-2 mt-2 text-xs text-muted-foreground",children:[t.intent_type&&e.jsxs(u,{variant:"outline",className:"text-xs",children:[e.jsx(te,{className:"w-3 h-3 mr-1"}),t.intent_type]}),t.confidence&&e.jsxs(u,{variant:"outline",className:"text-xs",children:[e.jsx(se,{className:"w-3 h-3 mr-1"}),Math.round(t.confidence*100),"%"]}),t.processing_time&&e.jsxs(u,{variant:"outline",className:"text-xs",children:[e.jsx(re,{className:"w-3 h-3 mr-1"}),t.processing_time.toFixed(2),"s"]})]});return g?e.jsxs("div",{className:"fixed bottom-0 right-0 z-40 w-full max-w-md sm:max-w-sm md:max-w-md lg:max-w-lg xl:max-w-xl h-[45vh] sm:h-[55vh] md:h-[65vh] lg:h-[75vh] xl:h-[80vh] bg-white border border-slate-200 rounded-2xl shadow-xl flex flex-col animate-fade-in md:bottom-0 md:mb-0 mb-[60px] md:mb-0",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-slate-200 bg-white rounded-t-2xl",children:[e.jsx("span",{className:"text-base font-semibold text-foreground",children:"ИИ чат-стилист"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(i,{variant:"ghost",size:"icon",onClick:()=>{E(!j),!j&&!o&&$()},className:"text-muted-foreground",title:"Статистика",children:e.jsx(X,{className:"w-4 h-4"})}),e.jsx(i,{variant:"ghost",size:"icon",onClick:R,className:"text-muted-foreground",title:"Очистить чат",children:e.jsx(Y,{className:"w-4 h-4"})}),e.jsx(i,{variant:"ghost",size:"icon",onClick:()=>y(!1),className:"text-muted-foreground",children:e.jsx(G,{className:"w-5 h-5"})})]})]}),j&&e.jsx("div",{className:"px-4 py-3 border-b border-slate-200 bg-slate-50",children:z?e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-primary"}),"Загрузка статистики..."]}):o?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Взаимодействий:"}),e.jsx("span",{className:"font-medium",children:o.interaction_count||0})]}),o.current_state&&e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Состояние:"}),e.jsx(u,{variant:"outline",className:"text-xs",children:o.current_state})]}),o.conversation_duration&&e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Длительность:"}),e.jsxs("span",{className:"font-medium",children:[Math.round(o.conversation_duration),"с"]})]})]}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"Статистика недоступна"})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[l.length===0?e.jsxs("div",{className:"text-center text-muted-foreground py-8",children:[e.jsx(A,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{className:"text-sm",children:"Привет! Я ваш ИИ-стилист. Задайте мне любой вопрос о моде, стиле или товарах!"})]}):l.map((t,r)=>e.jsxs("div",{className:`flex gap-3 ${t.role==="user"?"justify-end":"justify-start"}`,children:[t.role==="ai"&&e.jsx(k,{className:"w-8 h-8",children:ie}),e.jsxs("div",{className:`max-w-[80%] ${t.role==="user"?"order-2":"order-1"}`,children:[e.jsx("div",{className:`rounded-lg px-3 py-2 ${t.role==="user"?"bg-primary text-primary-foreground":"bg-muted"}`,children:e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:t.text})}),U(t),t.items&&t.items.length>0&&e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Найденные товары: (",t.items.length,")"]}),e.jsx("div",{className:"grid grid-cols-1 gap-2 max-w-full",children:t.items.slice(0,S.has(r)?t.items.length:3).map(s=>e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-white border rounded-lg hover:bg-gray-50 transition-colors overflow-hidden",children:[e.jsxs(O,{to:`/items/${s.id}`,className:"flex items-center gap-2 flex-1 min-w-0",children:[s.image_url?e.jsx("img",{src:s.image_url,alt:s.name||"Товар",className:"w-10 h-10 sm:w-12 sm:h-12 object-cover rounded flex-shrink-0",onError:x=>{x.currentTarget.style.display="none"}}):e.jsx("div",{className:"w-10 h-10 sm:w-12 sm:h-12 bg-gray-200 rounded flex items-center justify-center flex-shrink-0",children:e.jsx(Q,{className:"w-5 h-5 sm:w-6 sm:h-6 text-gray-400"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate text-gray-900",children:s.name||"Название не указано"}),e.jsxs("p",{className:"text-xs text-muted-foreground truncate",children:[s.brand&&`${s.brand} • `,s.price?`${s.price} ₸`:"Цена не указана"]})]}),e.jsx(oe,{className:"w-3.5 h-3.5 sm:w-4 sm:h-4 text-muted-foreground flex-shrink-0"})]}),e.jsx(i,{variant:"ghost",size:"icon",className:"h-7 w-7 sm:h-8 sm:w-8 text-green-600 hover:text-green-700 hover:bg-green-50 flex-shrink-0",onClick:()=>T(s),title:"Добавить в корзину",children:e.jsx(W,{className:"w-3.5 h-3.5 sm:w-4 sm:h-4"})})]},s.id))}),t.items.length>3&&e.jsx(i,{variant:"ghost",size:"sm",className:"w-full text-xs text-muted-foreground hover:text-foreground",onClick:()=>q(r),children:S.has(r)?e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"w-3 h-3 mr-1"}),"Показать меньше"]}):e.jsxs(e.Fragment,{children:[e.jsx(ee,{className:"w-3 h-3 mr-1"}),"Показать еще ",t.items.length-3," товаров"]})})]})]}),t.role==="user"&&e.jsx(k,{className:"w-8 h-8",children:le})]},r)),e.jsx("div",{ref:N})]}),e.jsx("div",{className:"p-4 border-t border-slate-200",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(J,{value:d,onChange:t=>v(t.target.value),onKeyPress:t=>t.key==="Enter"&&C(),placeholder:"Напишите сообщение...",disabled:p,className:"flex-1"}),e.jsx(i,{onClick:C,disabled:p||!d.trim(),children:p?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}):e.jsx(_,{className:"w-4 h-4"})})]})})]}):e.jsx(i,{variant:"outline",size:"icon",className:"fixed bottom-6 right-6 z-40 shadow-md border bg-white md:bottom-6 md:right-6 bottom-[80px] right-6 md:bottom-6 sm:bottom-6 lg:bottom-6 xl:bottom-6",onClick:()=>y(!0),"aria-label":"Открыть чат-стилист",children:e.jsx(_,{className:"w-6 h-6 text-muted-foreground"})})};export{Ie as default};
