import{j as e}from"./ui-DmaJfU4R.js";import{g as X,f as G,r as n}from"./router-YsGj19cs.js";import{I as b}from"./input-DSjIL0vM.js";import{T as H}from"./textarea-x4CJyvYj.js";import{u as J}from"./use-toast-BimaNeed.js";import{l as q,k as K}from"./index-dk87i_EB.js";import{g as V,u as W}from"./outfits-C5fD7Vbx.js";import{categoryConfig as m}from"./OutfitBuilder-Btb_LZpw.js";import{B as p}from"./button-CEL2MslA.js";import{L as R}from"./loader-circle-yzSCNo-f.js";import{S as Y}from"./search-DxfJQDsN.js";import{X as Z}from"./x-DBAcYj4I.js";import{S as ee}from"./save-CC2lNIMm.js";import"./vendor-BtP0CW_r.js";import"./utils-CytzSlOG.js";import"./ItemImage-C9AFigSL.js";import"./shopping-bag-Din1qLo_.js";import"./createLucideIcon-BcwDLXBm.js";import"./star-Cx7l4Pfa.js";import"./arrow-left-CZ8lUGg0.js";import"./arrow-right-ovKko4mr.js";import"./index-BwobEAja.js";const se={top:"top_ids",bottom:"bottom_ids",footwear:"footwear_ids",accessory:"accessories_ids",fragrance:"fragrances_ids"},Se=()=>{const{id:x}=X(),$=G(),{toast:h}=J(),[j,D]=n.useState({}),[w,k]=n.useState({}),[f,g]=n.useState({}),[F,M]=n.useState(!0),[S,C]=n.useState(!1),[N,_]=n.useState(""),[v,I]=n.useState(""),[E,L]=n.useState(""),[y,O]=n.useState(""),[z,B]=n.useState([]),T=n.useMemo(()=>{let s=0;return m.forEach(i=>{(f[i.key]||[]).forEach(a=>{typeof a.price=="number"&&(s+=a.price)})}),s},[f]);n.useEffect(()=>{(async()=>{if(x)try{const i={},r={};await Promise.all(m.map(async l=>{const o=(await Promise.all(l.apiTypes.map(u=>q({category:u,limit:50})))).flat();i[l.key]=o,r[l.key]=0}));const a=await V(Number(x));_(a.name),I(a.style),L(a.description??"");const t={};await Promise.all(m.map(async l=>{const c=a[l.key];if(!c||c.length===0){t[l.key]=[];return}const o=await Promise.all(c.map(async d=>{try{return await K(d.id)}catch{return{id:d.id,name:d.name,image_url:d.image_url}}}));t[l.key]=o;const u=new Set(i[l.key].map(d=>d.id));o.forEach(d=>{u.has(d.id)||i[l.key].unshift(d)})})),D(i),k(r),g(t)}catch(i){console.error(i),h({variant:"destructive",title:"Ошибка",description:"Не удалось загрузить данные образа"})}finally{M(!1)}})()},[x,h]),n.useEffect(()=>{const s=setTimeout(()=>{(async()=>{if(y.trim().length<2){B([]);return}try{const r=await q({q:y.trim(),limit:30});B(r)}catch(r){console.error(r)}})()},400);return()=>clearTimeout(s)},[y]);const P=(s,i)=>{k(r=>{const a=j[s]||[];if(a.length===0)return r;const t=r[s]??0,l=i==="next"?(t+1)%a.length:(t-1+a.length)%a.length;return{...r,[s]:l}})},A=s=>{g(i=>{var o;const r=j[s]||[],a=w[s]??0,t=r[a];if(!t)return i;const c=((o=i[s])==null?void 0:o.some(u=>u.id===t.id))??!1?i[s].filter(u=>u.id!==t.id):[...i[s]||[],t];return{...i,[s]:c}})},Q=s=>{const i=m.find(r=>r.apiTypes.some(a=>a===(s.category||"")));i&&g(r=>{var l;const t=((l=r[i.key])==null?void 0:l.some(c=>c.id===s.id))??!1?r[i.key]:[...r[i.key]||[],s];return{...r,[i.key]:t}})},U=async s=>{var r,a;if(s.preventDefault(),!x)return;if(!N.trim()||!v.trim()){h({variant:"destructive",title:"Заполните обязательные поля"});return}if(!m.some(t=>(f[t.key]||[]).length>0)){h({variant:"destructive",title:"Пустой образ",description:"Добавьте хотя бы один предмет"});return}C(!0);try{const t={name:N,style:v,description:E||void 0};m.forEach(l=>{const c=f[l.key]||[];t[se[l.key]]=c.map(o=>o.id)}),await W(Number(x),t),h({title:"Образ обновлен",description:"Возвращаемся на страницу образа"}),$(`/outfits/${x}`)}catch(t){console.error(t);const l=((a=(r=t==null?void 0:t.response)==null?void 0:r.data)==null?void 0:a.detail)||"Не удалось обновить образ";h({variant:"destructive",title:"Ошибка",description:l})}finally{C(!1)}};return F?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-white",children:e.jsx(R,{className:"h-6 w-6 animate-spin text-black"})}):e.jsx("div",{className:"min-h-screen bg-gray-100 py-8 px-4 sm:px-6 lg:px-8",children:e.jsxs("form",{onSubmit:U,className:"max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-[2fr_1fr] gap-8",children:[e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"bg-white p-6 rounded-2xl shadow-sm border",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Редактирование образа"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Название образа *"}),e.jsx(b,{value:N,onChange:s=>_(s.target.value),placeholder:"Введите название",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Стиль *"}),e.jsx(b,{value:v,onChange:s=>I(s.target.value),placeholder:"Кэжуал, деловой, спортивный...",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Описание"}),e.jsx(H,{value:E,onChange:s=>L(s.target.value),placeholder:"Добавьте описание образа...",rows:4})]})]})]}),e.jsxs("div",{className:"bg-white p-4 rounded-xl border",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(Y,{className:"w-4 h-4 text-muted-foreground"}),e.jsx(b,{placeholder:"Поиск товара...",value:y,onChange:s=>O(s.target.value),className:"w-full"})]}),e.jsx("div",{className:"space-y-2 max-h-60 overflow-auto",children:z.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded-md",children:[e.jsx("span",{className:"text-sm truncate",children:s.name}),e.jsx(p,{size:"sm",onClick:()=>Q(s),children:"Добавить"})]},s.id))})]}),m.map(s=>{const r=(j[s.key]||[])[w[s.key]],a=f[s.key]||[];return e.jsxs("div",{className:"bg-white p-4 rounded-xl border space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"font-semibold",children:s.label}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[a.length," выбрано"]})]}),e.jsxs("div",{className:"flex gap-3 items-center",children:[e.jsx(p,{onClick:()=>P(s.key,"prev"),children:"‹"}),e.jsx("div",{className:"flex-1",children:r?e.jsx("div",{className:"text-sm",children:r.name}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"Нет предметов"})}),e.jsx(p,{onClick:()=>P(s.key,"next"),children:"›"}),e.jsx(p,{variant:"outline",onClick:()=>A(s.key),children:r&&a.some(t=>t.id===r.id)?"Убрать":"Добавить"})]}),a.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:a.map(t=>e.jsxs("div",{className:"relative w-10 h-10 border rounded-md",children:[e.jsx("img",{src:t.image_url,alt:t.name,className:"w-full h-full object-cover rounded-md"}),e.jsx("button",{onClick:()=>g(l=>({...l,[s.key]:l[s.key].filter(c=>c.id!==t.id)})),className:"absolute -top-1 -right-1 bg-black text-white rounded-full w-4 h-4 text-xs flex items-center justify-center",children:e.jsx(Z,{className:"w-2 h-2"})})]},t.id))})]},s.key)})]}),e.jsxs("div",{className:"sticky top-6 space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-2xl border shadow-sm p-4 flex flex-col items-center",children:[e.jsxs("div",{className:"w-full aspect-[3/4] bg-gray-100 rounded overflow-hidden relative",children:[e.jsx("img",{src:"/maneken.jpg",className:"object-cover w-full h-full",alt:"Манекен"}),m.flatMap((s,i)=>(f[s.key]||[]).map((a,t)=>a.image_url?e.jsx("img",{src:a.image_url,alt:a.name,className:"absolute inset-0 w-full h-full object-cover",style:{zIndex:i+t+1}},`${s.key}-${a.id}`):null))]}),e.jsxs("div",{className:"pt-4 text-center",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Примерная стоимость"}),e.jsx("div",{className:"text-xl font-bold",children:T>0?`${T.toLocaleString("ru-RU")} ₽`:"—"})]})]}),e.jsx(p,{type:"submit",disabled:S,className:"w-full uppercase tracking-wide text-sm",children:S?e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"w-4 h-4 animate-spin mr-2"}),"Сохранение..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ee,{className:"w-4 h-4 mr-2"}),"Сохранить изменения"]})})]})]})})};export{Se as default};
