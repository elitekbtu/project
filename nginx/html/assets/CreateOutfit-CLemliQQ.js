import{j as e}from"./ui-DmaJfU4R.js";import{f as Y,r as l}from"./router-YsGj19cs.js";import{I as k}from"./input-DSjIL0vM.js";import{T as Z}from"./textarea-x4CJyvYj.js";import{u as ee}from"./use-toast-BimaNeed.js";import{l as U}from"./index-Czdh4XVO.js";import{f as te,i as se}from"./outfits-C9xau8vZ.js";import{categoryConfig as p}from"./OutfitBuilder--z9Lk4M7.js";import{B as y}from"./button-CEL2MslA.js";import{U as ae}from"./user-photo-upload-BobMTl5d.js";import{L as S}from"./loader-circle-yzSCNo-f.js";import{S as re}from"./search-DxfJQDsN.js";import{X as ie}from"./x-DBAcYj4I.js";import{S as ne}from"./sparkles-Dhcxexd3.js";import{S as le}from"./save-CC2lNIMm.js";import"./vendor-BtP0CW_r.js";import"./utils-CytzSlOG.js";import"./ItemImage-C9AFigSL.js";import"./shopping-bag-Din1qLo_.js";import"./createLucideIcon-BcwDLXBm.js";import"./star-Cx7l4Pfa.js";import"./arrow-left-CZ8lUGg0.js";import"./arrow-right-ovKko4mr.js";import"./index-BwobEAja.js";import"./upload-CEja7h-0.js";import"./user-BuBPZYTe.js";const $e=()=>{const q=Y(),{toast:h}=ee(),[N,A]=l.useState({}),[C,_]=l.useState({}),[u,j]=l.useState({}),[F,R]=l.useState(!0),[T,I]=l.useState(!1),[O,B]=l.useState(!1),[g,D]=l.useState(null),[f,z]=l.useState(""),[b,G]=l.useState(""),[w,M]=l.useState(""),[P,W]=l.useState(""),[v,Q]=l.useState(""),[V,E]=l.useState([]),$=l.useMemo(()=>{let t=0;return p.forEach(r=>{(u[r.key]||[]).forEach(s=>{typeof s.price=="number"&&(t+=s.price)})}),t},[u]);l.useEffect(()=>{(async()=>{try{const r={},a={},s={};await Promise.all(p.map(async i=>{const m=(await Promise.all(i.apiTypes.map(o=>U({category:o,limit:50})))).flat();r[i.key]=m,a[i.key]=0,s[i.key]=[]})),A(r),_(a),j(s)}catch(r){console.error(r),h({variant:"destructive",title:"Ошибка",description:"Не удалось загрузить список вещей"})}finally{R(!1)}})()},[h]),l.useEffect(()=>{const t=setTimeout(()=>{(async()=>{if(v.trim().length<2){E([]);return}try{const a=await U({q:v.trim(),limit:30});E(a)}catch(a){console.error(a)}})()},400);return()=>clearTimeout(t)},[v]);const L=(t,r)=>{_(a=>{const s=N[t]||[];if(s.length===0)return a;const i=a[t]??0,d=r==="next"?(i+1)%s.length:(i-1+s.length)%s.length;return{...a,[t]:d}})},X=t=>{j(r=>{var o;const a=N[t]||[],s=C[t]??0,i=a[s];if(!i)return r;const m=((o=r[t])==null?void 0:o.some(n=>n.id===i.id))??!1?r[t].filter(n=>n.id!==i.id):[...r[t]||[],i];return{...r,[t]:m}})},H=t=>{const r=p.find(a=>a.apiTypes.some(s=>s===(t.category||"")));r&&j(a=>{var d;const i=((d=a[r.key])==null?void 0:d.some(m=>m.id===t.id))??!1?a[r.key]:[...a[r.key]||[],t];return{...a,[r.key]:i}})},J=async t=>{var r,a,s,i,d,m,o;if(t.preventDefault(),!(!b||!w)){I(!0);try{const n={name:b,style:w,description:P,top_ids:((r=u.top)==null?void 0:r.map(x=>x.id))||[],bottom_ids:((a=u.bottom)==null?void 0:a.map(x=>x.id))||[],footwear_ids:((s=u.footwear)==null?void 0:s.map(x=>x.id))||[],accessories_ids:((i=u.accessory)==null?void 0:i.map(x=>x.id))||[],fragrances_ids:((d=u.fragrance)==null?void 0:d.map(x=>x.id))||[],tryon_image_url:g||void 0},c=await te(n);h({title:"Образ создан",description:"Образ успешно добавлен в коллекцию"}),q(`/outfits/${c.id}`)}catch(n){const c=((o=(m=n==null?void 0:n.response)==null?void 0:m.data)==null?void 0:o.detail)||"Не удалось создать образ";h({variant:"destructive",title:"Ошибка",description:c})}finally{I(!1)}}},K=async()=>{var r,a;if(!p.some(s=>(u[s.key]||[]).length>0)){h({variant:"destructive",title:"Нет выбранных предметов",description:"Добавьте хотя бы один предмет для генерации виртуальной примерки."});return}B(!0);try{const s=p.flatMap(o=>(u[o.key]||[]).map(c=>({id:c.id,name:c.name,image_url:c.image_url,category:c.category,price:c.price,brand:c.brand,color:c.color,description:c.description}))),i=p.reduce((o,n)=>(o[n.key]=(u[n.key]||[]).length,o),{}),d=Object.entries(i).filter(([o,n])=>n>0).map(([o,n])=>{var c;return`${(c=p.find(x=>x.key===o))==null?void 0:c.label}: ${n}`}).join(", ");if(h({title:"Начинаем виртуальную примерку",description:`Будет применено по одному предмету из каждой категории: ${d}`}),!f){h({variant:"destructive",title:"Фото не загружено",description:"Пожалуйста, загрузите свое фото для виртуальной примерки"});return}const m=await se({human_image_url:f,outfit_items:s});m.success?(D(m.result_image_url),h({title:"Виртуальная примерка готова",description:"Образ собран из предметов разных категорий"})):h({variant:"destructive",title:"Ошибка генерации",description:m.message||"Не удалось сгенерировать виртуальную примерку"})}catch(s){console.error(s);const i=((a=(r=s==null?void 0:s.response)==null?void 0:r.data)==null?void 0:a.detail)||"Не удалось сгенерировать виртуальную примерку";h({variant:"destructive",title:"Ошибка",description:i})}finally{B(!1)}};return F?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-white",children:e.jsx(S,{className:"h-6 w-6 animate-spin text-black"})}):e.jsx("div",{className:"min-h-screen bg-gray-100 py-8 px-4 sm:px-6 lg:px-8",children:e.jsxs("form",{onSubmit:J,className:"max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-[2fr_1fr] gap-8",children:[e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"bg-white p-6 rounded-2xl shadow-sm border",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Создание образа"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Название образа *"}),e.jsx(k,{value:b,onChange:t=>G(t.target.value),placeholder:"Введите название",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Стиль *"}),e.jsx(k,{value:w,onChange:t=>M(t.target.value),placeholder:"Кэжуал, деловой, спортивный...",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Описание"}),e.jsx(Z,{value:P,onChange:t=>W(t.target.value),placeholder:"Добавьте описание образа...",rows:4})]})]})]}),e.jsxs("div",{className:"bg-white p-4 rounded-xl border",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(re,{className:"w-4 h-4 text-muted-foreground"}),e.jsx(k,{placeholder:"Поиск товара...",value:v,onChange:t=>Q(t.target.value),className:"w-full"})]}),e.jsx("div",{className:"space-y-2 max-h-60 overflow-auto",children:V.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded-md",children:[e.jsx("span",{className:"text-sm truncate",children:t.name}),e.jsx(y,{size:"sm",onClick:()=>H(t),children:"Добавить"})]},t.id))})]}),p.map(t=>{const a=(N[t.key]||[])[C[t.key]],s=u[t.key]||[];return e.jsxs("div",{className:"bg-white p-4 rounded-xl border space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"font-semibold",children:t.label}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s.length," выбрано"]})]}),e.jsxs("div",{className:"flex gap-3 items-center",children:[e.jsx(y,{onClick:()=>L(t.key,"prev"),children:"‹"}),e.jsx("div",{className:"flex-1",children:a?e.jsx("div",{className:"text-sm",children:a.name}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"Нет предметов"})}),e.jsx(y,{onClick:()=>L(t.key,"next"),children:"›"}),e.jsx(y,{variant:"outline",onClick:()=>X(t.key),children:a&&s.some(i=>i.id===a.id)?"Убрать":"Добавить"})]}),s.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:s.map(i=>e.jsxs("div",{className:"relative w-10 h-10 border rounded-md",children:[e.jsx("img",{src:i.image_url,alt:i.name,className:"w-full h-full object-cover rounded-md"}),e.jsx("button",{onClick:()=>j(d=>({...d,[t.key]:d[t.key].filter(m=>m.id!==i.id)})),className:"absolute -top-1 -right-1 bg-black text-white rounded-full w-4 h-4 text-xs flex items-center justify-center",children:e.jsx(ie,{className:"w-2 h-2"})})]},i.id))})]},t.key)})]}),e.jsxs("div",{className:"sticky top-6 space-y-6",children:[e.jsx("div",{className:"bg-white rounded-2xl border shadow-sm p-4",children:e.jsx(ae,{onPhotoSelected:z,currentPhoto:f,className:""})}),e.jsxs("div",{className:"bg-white rounded-2xl border shadow-sm p-4 flex flex-col items-center",children:[e.jsx("div",{className:"w-full aspect-[3/4] bg-gray-100 rounded overflow-hidden relative",children:g?e.jsx("img",{src:g.startsWith("/")?`${window.location.origin}${g}`:g,className:"object-cover w-full h-full",alt:"Виртуальная примерка",onError:t=>{console.error("Ошибка загрузки изображения виртуальной примерки:",g),t.currentTarget.src="/maneken.jpg"}}):e.jsx("img",{src:"/maneken.jpg",className:"object-cover w-full h-full",alt:"Манекен"})}),e.jsxs("div",{className:"pt-4 text-center space-y-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Примерная стоимость"}),e.jsx("div",{className:"text-xl font-bold",children:$>0?`${$.toLocaleString("ru-RU")} ₽`:"—"}),e.jsx(y,{onClick:K,disabled:O||!f,variant:"default",size:"sm",className:"w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white disabled:opacity-50",children:O?e.jsxs(e.Fragment,{children:[e.jsx(S,{className:"w-4 h-4 animate-spin mr-2"}),"Сборка образа..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"w-4 h-4 mr-2"}),"Собрать образ"]})}),!f&&e.jsx("div",{className:"text-xs text-muted-foreground text-center",children:"Загрузите фото для активации"}),!p.some(t=>(u[t.key]||[]).length>0)&&f&&e.jsx("div",{className:"text-xs text-muted-foreground text-center",children:"Добавьте предметы для активации"}),p.some(t=>(u[t.key]||[]).length>0)&&f&&e.jsx("div",{className:"text-xs text-muted-foreground text-center",children:"Будет применено по одному предмету из каждой категории"})]})]}),e.jsx(y,{type:"submit",disabled:T,className:"w-full uppercase tracking-wide text-sm",children:T?e.jsxs(e.Fragment,{children:[e.jsx(S,{className:"w-4 h-4 animate-spin mr-2"}),"Сохранение..."]}):e.jsxs(e.Fragment,{children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),"Создать образ"]})})]})]})})};export{$e as default};
