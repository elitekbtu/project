import{j as e}from"./ui-Cqf_O7uz.js";import{f as P,g as A,r as h}from"./router-YsGj19cs.js";import{j as K,k as q,m as O,n as I,o as $,p as G,q as H,r as J}from"./index-DUoZO1f1.js";import{B as x}from"./button-D4DJKXVl.js";import{I as c}from"./input-CPWPjeQo.js";import{T as Q}from"./textarea-CvwRPQ_V.js";import{L as n}from"./label-DMmfaKU4.js";import{u as W}from"./use-toast-aHRkQ04f.js";import{S as X,a as Y,b as Z,c as ee,d as se}from"./select-DOTyNBHD.js";import{B as ae}from"./badge-DZ0IvmWb.js";import{D as te,a as re,b as le,c as _}from"./dropdown-menu-Rti6Aa4h.js";import{L as z}from"./loader-circle-yzSCNo-f.js";import{m as ie}from"./proxy-kgKBpva2.js";import{A as ce}from"./arrow-left-CZ8lUGg0.js";import{U as L}from"./upload-CEja7h-0.js";import{L as ne}from"./link-CS_HXgaU.js";import{T as b}from"./trash-2-BP15ZqUs.js";import{P as D}from"./plus-D0op2cnd.js";import{S as oe}from"./save-CC2lNIMm.js";import"./vendor-BtP0CW_r.js";import"./index-BwobEAja.js";import"./utils-CytzSlOG.js";import"./createLucideIcon-BcwDLXBm.js";import"./check-Jm2HgjeV.js";import"./chevron-right-CLAbP_dx.js";const de={name:"",brand:"",color:"",clothing_type:"top",image_url:"",description:"",price:void 0,category:"top",article:"",size:"",style:"",collection:""},me=[{value:"top",label:"Верх (футболки, рубашки, платья, куртки)"},{value:"bottom",label:"Низ (джинсы, юбки, шорты, брюки)"},{value:"footwear",label:"Обувь (кроссовки, туфли, ботинки)"},{value:"accessory",label:"Аксессуары (сумки, часы, очки)"},{value:"fragrance",label:"Ароматы (духи, парфюм)"}],Ve=()=>{const v=P(),{id:o}=A(),{toast:d}=W(),u=!!o,[i,j]=h.useState(de),[E,U]=h.useState(!0),[y,w]=h.useState(!1),[f,C]=h.useState([]),[g,m]=h.useState([]),[k,S]=h.useState([]),F=h.useRef(null);h.useEffect(()=>{(async()=>{try{if(u){const s=await q(Number(o));j({...s,clothing_type:s.category});try{const a=await O(Number(o));S(a)}catch{}}}catch{d({variant:"destructive",title:"Ошибка",description:"Не удалось загрузить данные о товаре"})}finally{U(!1)}})()},[o,u,d]),h.useEffect(()=>{(async()=>{if(u)try{const s=await I(Number(o));m(s.map(a=>({size:a.size,color:a.color,sku:a.sku,stock:a.stock,price:a.price})))}catch{}})()},[o,u]);const p=t=>{const{name:s,value:a}=t.target;j(l=>({...l,[s]:a}))},R=(t,s)=>{j(a=>({...a,category:s,clothing_type:s}))},T=t=>{const{name:s,value:a}=t.target;j(l=>({...l,[s]:a===""?void 0:Number(a)}))},V=t=>{if(!t.target.files)return;const s=Array.from(t.target.files);C(s)},B=t=>{C(s=>s.filter((a,l)=>l!==t))},M=async t=>{if(t.preventDefault(),!i.name.trim()){d({variant:"destructive",title:"Ошибка",description:"Название товара обязательно"});return}if(i.price!==void 0&&i.price<=0){d({variant:"destructive",title:"Ошибка",description:"Цена должна быть положительным числом"});return}w(!0);try{let s=null;if(u){const a={...i};await $(Number(o),a),s=Number(o),d({title:"Успешно",description:"Товар успешно обновлен"})}else{const a=new FormData;Object.entries(i).forEach(([r,N])=>{N!==void 0&&N!==""&&a.append(r,String(N))}),f.forEach(r=>{a.append("images",r)}),s=(await G(a)).id,d({title:"Успешно",description:"Товар успешно создан"})}if(s&&g.length>0){if(u){const a=await I(s);await Promise.all(a.map(l=>H(s,l.id)))}for(const a of g)await J(s,a)}v("/admin/items")}catch{d({variant:"destructive",title:"Ошибка",description:"Произошла ошибка при сохранении"})}finally{w(!1)}};return E?e.jsx("div",{className:"flex h-64 items-center justify-center",children:e.jsx(z,{className:"h-8 w-8 animate-spin text-primary"})}):e.jsxs(ie.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},className:"container mx-auto max-w-4xl px-4 py-8",children:[e.jsxs("div",{className:"mb-8 flex items-center gap-4",children:[e.jsx(x,{variant:"ghost",size:"icon",onClick:()=>v("/admin/items"),className:"shrink-0 hover:bg-accent/50",children:e.jsx(ce,{className:"h-5 w-5"})}),e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:u?"Редактирование товара":"Создание нового товара"})]}),e.jsxs("form",{onSubmit:M,className:"space-y-8",children:[e.jsxs("div",{className:"rounded-lg border bg-card p-6 shadow-sm",children:[e.jsx("h2",{className:"mb-6 text-xl font-semibold",children:"Основная информация"}),e.jsxs("div",{className:"grid gap-6 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"name",children:"Название*"}),e.jsx(c,{id:"name",name:"name",value:i.name,onChange:p,required:!0,placeholder:"Название товара"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"brand",children:"Бренд"}),e.jsx(c,{id:"brand",name:"brand",value:i.brand||"",onChange:p,placeholder:"Бренд"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"category",children:"Категория товара"}),e.jsxs(X,{value:i.category,onValueChange:t=>R("category",t),children:[e.jsx(Y,{children:e.jsx(Z,{placeholder:"Выберите категорию"})}),e.jsx(ee,{children:me.map(t=>e.jsx(se,{value:t.value,children:t.label},t.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"price",children:"Цена"}),e.jsx(c,{id:"price",name:"price",type:"number",value:i.price??"",onChange:T,placeholder:"Цена"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"size",children:"Размер"}),e.jsx(c,{id:"size",name:"size",value:i.size||"",onChange:p,placeholder:"Размер"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"color",children:"Цвет"}),e.jsx(c,{id:"color",name:"color",value:i.color||"",onChange:p,placeholder:"Цвет"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"article",children:"Артикул / SKU"}),e.jsx(c,{id:"article",name:"article",value:i.article||"",onChange:p,placeholder:"Уникальный артикул товара"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"style",children:"Стиль"}),e.jsx(c,{id:"style",name:"style",value:i.style||"",onChange:p,placeholder:"Классический, спорт-шик, casual..."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"collection",children:"Коллекция"}),e.jsx(c,{id:"collection",name:"collection",value:i.collection||"",onChange:p,placeholder:"Напр. Summer 2024"})]})]})]}),e.jsxs("div",{className:"rounded-lg border bg-card p-6 shadow-sm",children:[e.jsx("h2",{className:"mb-6 text-xl font-semibold",children:"Изображение и описание"}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"image_files",children:"Загрузить изображения"}),e.jsxs(te,{children:[e.jsx(re,{asChild:!0,children:e.jsxs(x,{type:"button",variant:"outline",size:"sm",className:"flex items-center gap-2",children:[e.jsx(L,{className:"h-4 w-4"}),e.jsx("span",{children:"Загрузить"})]})}),e.jsxs(le,{className:"w-40",children:[e.jsxs(_,{onSelect:t=>{var s;t.preventDefault(),(s=F.current)==null||s.click()},className:"flex items-center gap-2",children:[e.jsx(L,{className:"h-4 w-4"})," Файл"]}),e.jsxs(_,{onSelect:t=>{t.preventDefault();const s=prompt("Введите URL изображения:");if(s){if(!/^https?:\/\//.test(s)){d({variant:"destructive",title:"Ошибка",description:"URL должен начинаться с http:// или https://"});return}j(a=>({...a,image_url:s}))}},className:"flex items-center gap-2",children:[e.jsx(ne,{className:"h-4 w-4"})," Ссылка"]})]})]}),e.jsx("input",{id:"image_files",ref:F,name:"image_files",type:"file",accept:"image/*",multiple:!0,onChange:V,className:"hidden"}),e.jsx("span",{className:"text-sm text-muted-foreground block",children:f.length>0?`${f.length} файлов выбрано`:"Файлы не выбраны"})]}),(k.length>0||f.length>0)&&e.jsxs("div",{className:"grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4",children:[k.map(t=>e.jsxs("div",{className:"relative group h-40 w-full overflow-hidden rounded-lg border",children:[e.jsx("img",{src:t.image_url,alt:"Изображение товара",className:"h-full w-full object-cover"}),e.jsx("button",{type:"button",onClick:async()=>{if(confirm("Удалить изображение?"))try{await K(Number(o),t.id),S(s=>s.filter(a=>a.id!==t.id))}catch{d({variant:"destructive",title:"Ошибка",description:"Не удалось удалить изображение"})}},className:"absolute inset-0 flex items-center justify-center bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(b,{className:"h-6 w-6 text-white"})})]},t.id)),f.map((t,s)=>e.jsxs("div",{className:"relative group h-40 w-full overflow-hidden rounded-lg border",children:[e.jsx("img",{src:URL.createObjectURL(t),alt:`preview-${s}`,className:"h-full w-full object-cover"}),e.jsx("button",{type:"button",onClick:()=>B(s),className:"absolute inset-0 flex items-center justify-center bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(b,{className:"h-6 w-6 text-white"})})]},s))]}),i.image_url&&e.jsx("div",{className:"flex justify-center",children:e.jsx("div",{className:"relative h-48 w-48 overflow-hidden rounded-lg border-2 border-dashed border-muted-foreground/20",children:e.jsx("img",{src:i.image_url,alt:"Предпросмотр",className:"h-full w-full object-contain",onError:t=>{t.currentTarget.style.display="none"}})})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"description",children:"Описание"}),e.jsx(Q,{id:"description",name:"description",value:i.description||"",onChange:p,placeholder:"Подробное описание товара",rows:5,className:"min-h-[120px]"})]})]})]}),e.jsxs("div",{className:"rounded-lg border bg-card p-6 shadow-sm",children:[e.jsxs("div",{className:"mb-6 flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Вариации и остатки"}),e.jsxs(ae,{variant:"outline",className:"px-3 py-1",children:[g.length," вариаций"]})]}),g.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center rounded-lg border-2 border-dashed border-muted-foreground/20 p-8 text-center",children:[e.jsx("p",{className:"mb-4 text-muted-foreground",children:"Вариации ещё не добавлены"}),e.jsxs(x,{type:"button",variant:"outline",onClick:()=>m([{size:"",color:"",sku:"",stock:0,price:void 0}]),children:[e.jsx(D,{className:"mr-2 h-4 w-4"}),"Добавить вариацию"]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-12 gap-2 font-medium text-sm text-muted-foreground",children:[e.jsx("div",{className:"col-span-3",children:"Размер"}),e.jsx("div",{className:"col-span-2",children:"Цвет"}),e.jsx("div",{className:"col-span-2",children:"SKU"}),e.jsx("div",{className:"col-span-2",children:"Остаток"}),e.jsx("div",{className:"col-span-2",children:"Цена"}),e.jsx("div",{className:"col-span-1"})]}),g.map((t,s)=>e.jsxs("div",{className:"grid grid-cols-12 items-center gap-2",children:[e.jsx(c,{className:"col-span-3",placeholder:"Размер",value:t.size||"",onChange:a=>{m(l=>{const r=[...l];return r[s].size=a.target.value,r})}}),e.jsx(c,{className:"col-span-2",placeholder:"Цвет",value:t.color||"",onChange:a=>{m(l=>{const r=[...l];return r[s].color=a.target.value,r})}}),e.jsx(c,{className:"col-span-2",placeholder:"SKU",value:t.sku||"",onChange:a=>{m(l=>{const r=[...l];return r[s].sku=a.target.value,r})}}),e.jsx(c,{className:"col-span-2",type:"number",placeholder:"Остаток",value:t.stock??"",onChange:a=>{m(l=>{const r=[...l];return r[s].stock=Number(a.target.value),r})}}),e.jsx(c,{className:"col-span-2",type:"number",placeholder:"Цена",value:t.price??"",onChange:a=>{m(l=>{const r=[...l];return r[s].price=a.target.value===""?void 0:Number(a.target.value),r})}}),e.jsx(x,{type:"button",variant:"ghost",size:"icon",className:"text-destructive hover:text-destructive",onClick:()=>m(a=>a.filter((l,r)=>r!==s)),children:e.jsx(b,{className:"h-4 w-4"})})]},s)),e.jsxs(x,{type:"button",variant:"outline",onClick:()=>m([...g,{size:"",color:"",sku:"",stock:0,price:void 0}]),children:[e.jsx(D,{className:"mr-2 h-4 w-4"}),"Добавить вариацию"]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(x,{type:"button",variant:"outline",onClick:()=>v("/admin/items"),children:"Отмена"}),e.jsx(x,{type:"submit",disabled:y,className:"min-w-32",children:y?e.jsxs(e.Fragment,{children:[e.jsx(z,{className:"mr-2 h-4 w-4 animate-spin"}),"Сохранение..."]}):e.jsxs(e.Fragment,{children:[e.jsx(oe,{className:"mr-2 h-4 w-4"}),"Сохранить"]})})]})]})]})};export{Ve as default};
