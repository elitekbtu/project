#!/usr/bin/env python3
"""
–ì–ª–∞–≤–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ –≤—Å–µ—Ö –∞–≥–µ–Ω—Ç–æ–≤
"""

import time
import uuid
from typing import Dict, Any, List, Optional
from datetime import datetime
from .base_agent import BaseAgent, AgentResult, ConversationContext, UserContext, FallbackHandler
from .intent_recognition_agent import IntentRecognitionAgent, IntentType
from .context_analysis_agent import ContextAnalysisAgent
from .user_behavior_agent import UserBehaviorAgent
from .response_generation_agent import ResponseGenerationAgent
from .style_agent import StyleAgent

class ConversationManager(BaseAgent):
    """–ì–ª–∞–≤–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —Ä–∞–∑–≥–æ–≤–æ—Ä–∞, –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É—é—â–∏–π –≤—Å–µ—Ö –∞–≥–µ–Ω—Ç–æ–≤"""
    
    def __init__(self):
        super().__init__("conversation_manager")
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—Å–µ—Ö –∞–≥–µ–Ω—Ç–æ–≤
        self.intent_agent = IntentRecognitionAgent()
        self.context_agent = ContextAnalysisAgent()
        self.behavior_agent = UserBehaviorAgent()
        self.response_agent = ResponseGenerationAgent()
        self.style_agent = StyleAgent()
        
        # –ö—ç—à –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        self.user_contexts: Dict[str, ConversationContext] = {}
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã
        self.system_stats = {
            'total_conversations': 0,
            'successful_conversations': 0,
            'failed_conversations': 0,
            'average_response_time': 0.0,
            'agent_performance': {}
        }
        
        self.logger.info("ConversationManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å–æ –≤—Å–µ–º–∏ –∞–≥–µ–Ω—Ç–∞–º–∏")
    
    async def process(self, input_data: Dict[str, Any], context: ConversationContext) -> AgentResult:
        """–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞ process –∏–∑ BaseAgent"""
        start_time = time.time()
        
        try:
            user_message = input_data.get('message', '')
            user_id = input_data.get('user_id')
            
            self.logger.info(f"–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: '{user_message[:50]}...'")
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º —Ü–µ–ø–æ—á–∫—É –∞–≥–µ–Ω—Ç–æ–≤
            result = await self._process_agent_chain(input_data, context)
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            processing_time = time.time() - start_time
            self._update_system_stats(result, processing_time)
            
            return result
            
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –≤ ConversationManager: {e}")
            processing_time = time.time() - start_time
            return AgentResult(
                success=False,
                error_message=str(e),
                processing_time=processing_time
            )

    async def process_message(self, user_message: str, user_id: Optional[int] = None, 
                           user_profile=None, db=None) -> Dict[str, Any]:
        """–û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        start_time = time.time()
        
        try:
            self.logger.info(f"–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: '{user_message[:50]}...'")
            
            # 1. –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            context = self._get_or_create_context(user_id)
            
            # 2. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            input_data = {
                'message': user_message,
                'user_id': user_id,
                'user_profile': user_profile,
                'db': db
            }
            
            # 3. –ó–∞–ø—É—Å–∫–∞–µ–º —Ü–µ–ø–æ—á–∫—É –∞–≥–µ–Ω—Ç–æ–≤
            result = await self._process_agent_chain(input_data, context)
            
            # 4. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            processing_time = time.time() - start_time
            self._update_system_stats(result, processing_time)
            
            # 5. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
            final_response = self._prepare_final_response(result, context)
            
            self.logger.info(f"–°–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞ {processing_time:.2f}—Å")
            return final_response
            
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –≤ ConversationManager: {e}")
            processing_time = time.time() - start_time
            return self._create_error_response(str(e), processing_time)
    
    async def _process_agent_chain(self, input_data: Dict[str, Any], context: ConversationContext) -> AgentResult:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ü–µ–ø–æ—á–∫—É –∞–≥–µ–Ω—Ç–æ–≤"""
        chain_start_time = time.time()
        
        try:
            # 1. –ê–Ω–∞–ª–∏–∑ –Ω–∞–º–µ—Ä–µ–Ω–∏–π
            self.logger.info("üîç –®–∞–≥ 1: –ê–Ω–∞–ª–∏–∑ –Ω–∞–º–µ—Ä–µ–Ω–∏–π")
            intent_result = await self.intent_agent.process(input_data, context)
            
            if not intent_result.success:
                self.logger.warning("–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback")
                return self._create_fallback_response("–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏–π")
            
            intent_data = intent_result.data.get('intent_result')
            input_data['intent_result'] = intent_data
            
            # 2. –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            self.logger.info("üìä –®–∞–≥ 2: –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞")
            context_result = await self.context_agent.process(input_data, context)
            
            if not context_result.success:
                self.logger.warning("–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –Ω–µ–≥–æ")
            
            context_data = context_result.data if context_result.success else {}
            input_data['context_analysis'] = context_data
            
            # 3. –ê–Ω–∞–ª–∏–∑ –ø–æ–≤–µ–¥–µ–Ω–∏—è
            self.logger.info("üß† –®–∞–≥ 3: –ê–Ω–∞–ª–∏–∑ –ø–æ–≤–µ–¥–µ–Ω–∏—è")
            behavior_result = await self.behavior_agent.process(input_data, context)
            
            if not behavior_result.success:
                self.logger.warning("–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –Ω–µ–≥–æ")
            
            behavior_data = behavior_result.data if behavior_result.success else {}
            input_data['behavior_analysis'] = behavior_data
            
            # 4. –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω—É–∂–µ–Ω –ª–∏ –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤
            if intent_data and intent_data.intent == IntentType.PRODUCT_REQUEST:
                self.logger.info("üõçÔ∏è –®–∞–≥ 4: –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤")
                product_result = await self._handle_product_search(input_data, context)
                input_data['product_result'] = product_result
            else:
                input_data['product_result'] = None
            
            # 5. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
            self.logger.info("üí¨ –®–∞–≥ 5: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞")
            response_result = await self.response_agent.process(input_data, context)
            
            if not response_result.success:
                self.logger.warning("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback")
                return self._create_fallback_response("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞")
            
            # 6. –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
            self._update_conversation_context(context, intent_data, input_data)
            
            # 7. –°–æ–∑–¥–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            chain_processing_time = time.time() - chain_start_time
            # –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
            product_result = input_data.get('product_result')
            if product_result is None:
                product_result = {}
            
            context_analysis = input_data.get('context_analysis')
            if context_analysis is None:
                context_analysis = {}
            
            response_data = response_result.data if response_result.data is not None else {}
            
            final_result = AgentResult(
                success=True,
                data={
                    'response': response_data.get('response', ''),
                    'intent': intent_data.intent.value if intent_data else 'unclear',
                    'confidence': intent_data.confidence if intent_data else 0.0,
                    'products': product_result.get('items', []),
                    'context_hints': context_analysis.get('context_hints', []),
                    'personalization': response_data.get('personalization', {}),
                    'processing_steps': [
                        'intent_recognition',
                        'context_analysis', 
                        'behavior_analysis',
                        'product_search' if product_result else None,
                        'response_generation'
                    ]
                },
                confidence=min(intent_data.confidence if intent_data else 0.0, response_result.confidence),
                processing_time=chain_processing_time
            )
            
            return final_result
            
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –≤ —Ü–µ–ø–æ—á–∫–µ –∞–≥–µ–Ω—Ç–æ–≤: {e}")
            import traceback
            self.logger.error(f"Traceback: {traceback.format_exc()}")
            return self._create_fallback_response(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: {str(e)}")
    
    async def _handle_product_search(self, input_data: Dict[str, Any], context: ConversationContext) -> Dict[str, Any]:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤"""
        search_start_time = time.time()
        
        try:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –º–µ—Ç–æ–¥ process() StyleAgent
            self.logger.info(f"–í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞: '{input_data.get('message', '')[:50]}...'")
            
            # –í—ã–∑—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –º–µ—Ç–æ–¥ process() –∞–≥–µ–Ω—Ç–∞
            agent_result = await self.style_agent.process(input_data, context)
            
            search_time = time.time() - search_start_time
            
            if agent_result.success:
                items_count = len(agent_result.data.get('items', []))
                self.logger.info(f"–ü–æ–∏—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω –∑–∞ {search_time:.2f}—Å, –Ω–∞–π–¥–µ–Ω–æ {items_count} —Ç–æ–≤–∞—Ä–æ–≤")
                
                return {
                    'items': agent_result.data.get('items', []),
                    'search_performed': True,
                    'search_query': input_data.get('message', ''),
                    'search_time': search_time,
                    'items_count': items_count,
                    'response': agent_result.data.get('response', '')
                }
            else:
                self.logger.warning(f"–ü–æ–∏—Å–∫ –Ω–µ —É–¥–∞–ª—Å—è: {agent_result.error_message}")
                return {
                    'items': [],
                    'search_performed': False,
                    'error': agent_result.error_message,
                    'search_time': search_time
                }
            
        except Exception as e:
            search_time = time.time() - search_start_time
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞ {search_time:.2f}—Å: {e}")
            return {
                'items': [], 
                'search_performed': False, 
                'error': str(e),
                'search_time': search_time
            }
    
    def _get_or_create_context(self, user_id: Optional[int]) -> ConversationContext:
        """–ü–æ–ª—É—á–∞–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        # –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_key = str(user_id) if user_id else f"anonymous_{uuid.uuid4().hex[:8]}"
        
        if user_key not in self.user_contexts:
            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
            user_context = UserContext(
                user_id=user_id,
                session_id=uuid.uuid4().hex,
                last_interaction=datetime.now()
            )
            
            conversation_context = ConversationContext(
                user_context=user_context,
                current_state='greeting'
            )
            
            self.user_contexts[user_key] = conversation_context
            self.logger.info(f"–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_key}")
        
        return self.user_contexts[user_key]
    
    def _update_conversation_context(self, context: ConversationContext, intent_data, input_data: Dict[str, Any]):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞"""
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
        if intent_data:
            previous_state = context.current_state
            
            if intent_data.intent == IntentType.GREETING:
                context.current_state = 'greeting'
            elif intent_data.intent == IntentType.PRODUCT_REQUEST:
                context.current_state = 'product_search'
            elif intent_data.intent == IntentType.SIZE_HELP:
                context.current_state = 'size_help'
            elif intent_data.intent == IntentType.STYLE_ADVICE:
                context.current_state = 'style_advice'
            elif intent_data.intent == IntentType.COMPLAINT:
                context.current_state = 'complaint'
            elif intent_data.intent == IntentType.QUESTION:
                context.current_state = 'question'
            elif intent_data.intent == IntentType.GOODBYE:
                context.current_state = 'goodbye'
            elif intent_data.intent == IntentType.SMALL_TALK:
                context.current_state = 'small_talk'
            else:
                context.current_state = 'unclear'
            
            # –õ–æ–≥–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            if previous_state != context.current_state:
                self.logger.info(f"–°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å: {previous_state} -> {context.current_state}")
        
        # –î–æ–±–∞–≤–ª—è–µ–º —à–∞–≥ –≤ –ø–æ—Ç–æ–∫ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
        if intent_data:
            context.conversation_flow.append(intent_data.intent.value)
            
            # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
            if len(context.conversation_flow) > 50:
                context.conversation_flow = context.conversation_flow[-50:]
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
        context.user_context.last_interaction = datetime.now()
        context.user_context.interaction_count += 1
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∞–≥–µ–Ω—Ç–æ–≤
        if intent_data:
            self.intent_agent.update_stats(AgentResult(success=True), 0.0)
    
    def _prepare_final_response(self, result: AgentResult, context: ConversationContext) -> Dict[str, Any]:
        """–ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ data –Ω–µ None
        data = result.data if result.data is not None else {}
        
        return {
            'reply': data.get('response', '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑!'),
            'items': data.get('items', data.get('products', [])),  # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö –∫–ª—é—á–µ–π
            'intent': data.get('intent', 'unclear'),
            'confidence': result.confidence,
            'context_hints': data.get('context_hints', []),
            'personalization': data.get('personalization', {}),
            'processing_time': result.processing_time,
            'conversation_state': context.current_state,
            'user_interaction_count': context.user_context.interaction_count,
            'success': result.success
        }
    
    def _create_error_response(self, error_message: str, processing_time: float) -> Dict[str, Any]:
        """–°–æ–∑–¥–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ–± –æ—à–∏–±–∫–µ"""
        return {
            'reply': f"–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {error_message}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑!",
            'items': [],
            'intent': 'error',
            'confidence': 0.0,
            'context_hints': ['error_occurred'],
            'personalization': {},
            'processing_time': processing_time,
            'conversation_state': 'error',
            'user_interaction_count': 0,
            'success': False
        }
    
    def _create_fallback_response(self, error_message: str) -> AgentResult:
        """–°–æ–∑–¥–∞–µ—Ç fallback –æ—Ç–≤–µ—Ç"""
        return FallbackHandler.create_fallback_result(
            error_message,
            {
                'response': "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑!",
                'intent': 'unclear',
                'confidence': 0.1,
                'products': [],
                'context_hints': ['fallback_used'],
                'personalization': {}
            }
        )
    
    def _update_system_stats(self, result: AgentResult, processing_time: float):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–∏—Å—Ç–µ–º—ã"""
        self.system_stats['total_conversations'] += 1
        
        if result.success:
            self.system_stats['successful_conversations'] += 1
        else:
            self.system_stats['failed_conversations'] += 1
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
        total_conversations = self.system_stats['total_conversations']
        current_avg = self.system_stats['average_response_time']
        self.system_stats['average_response_time'] = (
            (current_avg * (total_conversations - 1) + processing_time) / total_conversations
        )
    
    def get_system_stats(self) -> Dict[str, Any]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–∏—Å—Ç–µ–º—ã"""
        stats = self.system_stats.copy()
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∞–≥–µ–Ω—Ç–æ–≤
        stats['agent_stats'] = {
            'intent_recognition': self.intent_agent.get_stats(),
            'context_analysis': self.context_agent.get_stats(),
            'user_behavior': self.behavior_agent.get_stats(),
            'response_generation': self.response_agent.get_stats(),
            'style_agent': self.style_agent.get_stats()
        }
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞—Ö
        stats['active_contexts'] = len(self.user_contexts)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤
        state_stats = {}
        for context in self.user_contexts.values():
            state = context.current_state
            state_stats[state] = state_stats.get(state, 0) + 1
        
        stats['conversation_states'] = state_stats
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        if stats['total_conversations'] > 0:
            stats['success_rate'] = stats['successful_conversations'] / stats['total_conversations']
            stats['failure_rate'] = stats['failed_conversations'] / stats['total_conversations']
        else:
            stats['success_rate'] = 0.0
            stats['failure_rate'] = 0.0
        
        return stats
    
    def reset_user_context(self, user_id: Optional[int] = None):
        """–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if user_id:
            user_key = str(user_id)
            if user_key in self.user_contexts:
                del self.user_contexts[user_key]
                self.logger.info(f"–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —Å–±—Ä–æ—à–µ–Ω")
        else:
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã
            self.user_contexts.clear()
            self.logger.info("–í—Å–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–±—Ä–æ—à–µ–Ω—ã")
    
    def get_user_context(self, user_id: Optional[int]) -> Optional[ConversationContext]:
        """–ü–æ–ª—É—á–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        user_key = str(user_id) if user_id else None
        return self.user_contexts.get(user_key) if user_key else None
    
    def cleanup_old_contexts(self, max_age_hours: int = 24):
        """–û—á–∏—â–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã"""
        current_time = datetime.now()
        keys_to_remove = []
        
        for user_key, context in self.user_contexts.items():
            if context.user_context.last_interaction:
                age = current_time - context.user_context.last_interaction
                if age.total_seconds() > max_age_hours * 3600:
                    keys_to_remove.append(user_key)
        
        for key in keys_to_remove:
            del self.user_contexts[key]
        
        if keys_to_remove:
            self.logger.info(f"–û—á–∏—â–µ–Ω–æ {len(keys_to_remove)} —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤")
    
    def get_conversation_summary(self, user_id: Optional[int]) -> Dict[str, Any]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–≤–æ–¥–∫—É —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        context = self.get_user_context(user_id)
        if not context:
            return {'error': '–ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'}
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ—Ç–æ–∫ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
        intent_counts = {}
        for intent in context.conversation_flow:
            intent_counts[intent] = intent_counts.get(intent, 0) + 1
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç—ã–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è
        most_common_intents = sorted(intent_counts.items(), key=lambda x: x[1], reverse=True)[:3]
        
        return {
            'user_id': context.user_context.user_id,
            'session_id': context.user_context.session_id,
            'interaction_count': context.user_context.interaction_count,
            'conversation_flow': context.conversation_flow,
            'current_state': context.current_state,
            'favorite_categories': context.user_context.favorite_categories,
            'style_preferences': context.user_context.style_preferences,
            'price_range': context.user_context.price_range,
            'size_preferences': context.user_context.size_preferences,
            'last_interaction': context.user_context.last_interaction.isoformat() if context.user_context.last_interaction else None,
            'mood': context.user_context.mood.value,
            'conversation_duration': self._calculate_conversation_duration(context),
            'intent_analysis': {
                'total_intents': len(context.conversation_flow),
                'most_common_intents': most_common_intents,
                'intent_distribution': intent_counts
            },
            'preferences_summary': {
                'has_style_preferences': len(context.user_context.style_preferences) > 0,
                'has_size_preferences': len(context.user_context.size_preferences) > 0,
                'has_price_range': bool(context.user_context.price_range),
                'favorite_categories_count': len(context.user_context.favorite_categories)
            }
        }
    
    def _calculate_conversation_duration(self, context: ConversationContext) -> float:
        """–í—ã—á–∏—Å–ª—è–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö"""
        if not context.user_context.conversation_history:
            return 0.0
        
        first_message = context.user_context.conversation_history[0]['timestamp']
        last_message = context.user_context.conversation_history[-1]['timestamp']
        duration = last_message - first_message
        return duration.total_seconds() / 60
    
    def export_conversation_data(self, user_id: Optional[int] = None) -> Dict[str, Any]:
        """–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –≤ JSON-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ"""
        if user_id:
            # –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            context = self.get_user_context(user_id)
            if not context:
                return {'error': '–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω'}
            
            return {
                'user_data': self.get_conversation_summary(user_id),
                'export_timestamp': datetime.now().isoformat(),
                'export_type': 'single_user'
            }
        else:
            # –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
            all_contexts = {}
            for user_key, context in self.user_contexts.items():
                try:
                    user_id_from_key = int(user_key) if user_key.isdigit() else None
                    all_contexts[user_key] = self.get_conversation_summary(user_id_from_key)
                except (ValueError, KeyError):
                    continue
            
            return {
                'all_users_data': all_contexts,
                'system_stats': self.get_system_stats(),
                'export_timestamp': datetime.now().isoformat(),
                'export_type': 'all_users',
                'total_users': len(all_contexts)
            }
    
    def get_performance_metrics(self) -> Dict[str, Any]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã"""
        stats = self.get_system_stats()
        
        # –í—ã—á–∏—Å–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
        total_agents = len(stats['agent_stats'])
        agent_success_rates = {}
        
        for agent_name, agent_stats in stats['agent_stats'].items():
            total_requests = agent_stats.get('requests_processed', 0)
            successful_requests = agent_stats.get('successful_requests', 0)
            
            if total_requests > 0:
                success_rate = successful_requests / total_requests
                agent_success_rates[agent_name] = {
                    'success_rate': success_rate,
                    'total_requests': total_requests,
                    'average_processing_time': agent_stats.get('average_processing_time', 0.0)
                }
        
        return {
            'overall_success_rate': stats.get('success_rate', 0.0),
            'average_response_time': stats.get('average_response_time', 0.0),
            'agent_performance': agent_success_rates,
            'active_conversations': stats.get('active_contexts', 0),
            'conversation_states_distribution': stats.get('conversation_states', {}),
            'system_health': {
                'total_conversations': stats.get('total_conversations', 0),
                'error_rate': stats.get('failure_rate', 0.0),
                'uptime_metric': 'healthy' if stats.get('success_rate', 0.0) > 0.8 else 'degraded'
            }
        } 